## 组件封装思想

### view

#### 页面组件设计

一个页面分为上下三部分

page-search

page-content

page-modal

```js
<page-search :searchConfig="searchFormConfig" />
    <page-content
      pageName="department"
      ref="pageContentRef"
      :contentConfig="contentTableConfig"
      @newBtnClick="handleNewData"
      @editBtnClick="handleEditData"
    ></page-content>
    <page-modal
      ref="pageModalRef"
      :defaultInfo="modalInfo"
      :modalConfig="modalConfigRef"
      pageName="department"
    ></page-modal>
```

组件目录下config目录

searchFormConfig 

```js
export const contentTableConfig = {
  title: '部门列表',
  propList: [
    { prop: 'name', label: '部门名称', minWidth: '120' },
    { prop: 'leader', label: '部门领导', minWidth: '120' },
    { prop: 'parentId', label: '上级部门', minWidth: '120' },
    { prop: 'createAt', label: '创建时间', minWidth: '250', slotName: 'create' },
    { prop: 'updateAt', label: '更新时间', minWidth: '250', slotName: 'update' },
    { label: '操作', minWidth: '120', slotName: 'handler' }
  ],
  showIndexColumn: true,
  showSelectColumn: true
}

```

contentTableConfig

```js
export const modalConfig: IForm = {
  title: '新建部门',
  formItems: [
    { field: 'name', type: 'input', label: '部门名称', placeHolder: '请输入部门名称' },
    {
      field: 'parentId',
      type: 'select',
      label: '上级部门',
      placeHolder: '请选择上级部门',
      options: []
    },
    { field: 'leader', type: 'input', label: '领导名称', placeHolder: '请输入领导名称' }
  ],
  colLayout: { span: 24 },
  itemStyle: { padding: 0 }
}

```

modalConfig

```js
export const searchFormConfig: IForm = {
  formItems: [
    {
      field: 'name',
      type: 'input',
      label: '部门名称',
      placeHolder: '请输入部门名称',
      rules: []
    },
    {
      field: 'leader',
      type: 'input',
      label: '部门领导',
      placeHolder: '请输入部门领导',
      rules: []
    },
    {
      field: 'createAt',
      type: 'datepicker',
      label: '创建时间',
      rules: [],
      otherOption: {
        startPlaceholder: '开始时间',
        endPlaceholder: '结束时间',
        type: 'daterange'
      }
    }
  ],
  labelWidth: '100px',
  itemStyle: { padding: '10px 40px' },
  colLayout: { span: 8 }
}
```

#### 方法调用

```js
 const [pageContentRef, handleQueryClick, handleResetClick] = usePageSearch()
 // 处理modal的hook
    const [modalInfo, pageModalRef, handleNewData, handleEditData] = usePageModal()
 // modal配置信息
    const store = useStore()
    const modalConfigRef = computed(() => {
      const parentIdItem = modalConfig.formItems?.find((item) => item.field === 'parentId')
      parentIdItem!.options = store.state.entireDepartments.map((item) => {
        return { label: item.name, value: item.id }
      })
      return modalConfig
    })
```



### components

#### page-search

使用hy-form   设置footer插槽

给2个按钮绑定

```js
<template>
  <div>
    <hy-form v-bind="searchConfig" v-model="formData">
      <template #footer>
        <div class="btns">
          <el-button size="medium" icon="el-icon-refresh" @click="handleResetClick">重置</el-button>
          <el-button type="primary" size="medium" icon="el-icon-search" @click="handleQueryClick"
            >查询</el-button
          >
        </div>
      </template>
    </hy-form>
  </div>
</template>
```

给按钮绑定方法 然后将按钮点击方法emit出去

```js
emits: ['queryBtnClick', 'resetBtnClick'],
setup(props, { emit }) {
const handleResetClick = () => {
      for (const key in originFormData) {
        formData.value[`${key}`] = originFormData[key]
      }
      emit('resetBtnClick')
    }

    const handleQueryClick = () => {
      console.log({ ...formData.value })
      emit('queryBtnClick', formData.value)
    }
    }
```

在view的组件中调用   绑定了emit出去的方法

```js
<page-search
      :searchConfig="searchFormConfig"
      @queryBtnClick="handleQueryClick"
      @resetBtnClick="handleResetClick"
    />
const [pageContentRef, handleQueryClick, handleResetClick] = usePageSearch()
```



#### page-content（最复杂）

使用hy-table 使用插槽

```js
<template>
  <div class="page-content">
    <hy-table
      :totalCount="totalCount"
      :listData="pageListData"
      v-bind="contentConfig"
      v-model:page="pageInfo"
    >
      <template #headerHandler>
        <el-button v-if="isCreate" type="primary" size="medium" @click="handleNewData">
          {{ contentConfig.newBtnTitle ?? '新建数据' }}
        </el-button>
      </template>

      <template #status="scope">
        <el-button :type="scope.row.enable ? 'success' : 'danger'" size="mini" plain>
          {{ $filters.showStatus(scope.row.enable) }}
        </el-button>
      </template>
      <template #create="scope">
        {{ $filters.formatTime(scope.row.createAt) }}
      </template>
      <template #update="scope">
        {{ $filters.formatTime(scope.row.updateAt) }}
      </template>
      <template #handler="scope">
        <div class="handler">
          <el-button
            v-if="isUpdate"
            type="text"
            icon="el-icon-edit"
            size="mini"
            @click="handleEditClick(scope.row)"
          >
            编辑
          </el-button>
          <el-button
            v-if="isDelete"
            type="text"
            icon="el-icon-delete"
            size="mini"
            @click="handleDeleteClick(scope.row)"
          >
            删除
          </el-button>
        </div>
<!-- 在page-content中动态插入剩余的插槽 -->
      </template>
      <template v-for="item in otherPropSlots" :key="item.prop" #[item.slotName]="scope">
        <template v-if="item.slotName">
          <slot :name="item.slotName" :row="scope.row"></slot>
        </template>
      </template>
      <!-- <template #imageSlot="scope">
        <slot name="imageSlot" :row="scope.row"></slot>
      </template> -->
    </hy-table>
  </div>
</template>
```

接受信息

```js
components: {
    HyTable
  },
  props: {
    contentConfig: {
      type: Object,
      required: true
    },
    pageName: {
      type: String,
      required: true
    }
  },
```

通过dispatch获取数据  删除操作

```js
// 2.获取数据
    const getPageData = (otherInfo: any = {}) => {
      if (!isQuery) return
      otherQueryInfo = otherInfo
      store.dispatch('system/getPageListDataAction', {
        pageName: props.pageName,
        queryInfo: {
          offset: (pageInfo.value.currentPage - 1) * pageInfo.value.pageSize,
          size: pageInfo.value.pageSize,
          ...otherInfo
        }
      })
    }
    
   // 删除操作
    const handleDeleteClick = (rowItem: any) => {
      store.dispatch('system/deletePageDataAction', {
        pageName: props.pageName,
        queryInfo: {
          offset: pageInfo.value.currentPage * pageInfo.value.pageSize,
          size: pageInfo.value.pageSize,
          ...otherQueryInfo
        },
        id: rowItem.id
      })
    }
    
    // 2.获取页面数据
    const pageListData = computed(() => store.getters['system/pageListData'](props.pageName))

    // 3.footer
    const totalCount = computed(() => store.getters['system/pageListDataCount'](props.pageName))
```

emit方法

```js
  emits: ['newBtnClick', 'editBtnClick'],
  setup(props, { emit }) {
      
      
       
     // 6.新建数据 弹出对话框
const handleNewData = () => {
      emit('newBtnClick')
    }
  //		
const handleEditClick = (item: any) => {
      emit('editBtnClick', item)
    }
  }
```



#### page-modal

el-dialog内使用 hy-form

设置slot 接受 `<pagemodal> 内容 </pagemodal>`内容

设置template footer插槽模板

```js
<template>
  <div class="page-modal">
    <el-dialog
      :title="modalConfig.title"
      v-model="dialogVisible"
      width="30%"
      center
      destroy-on-close
    >
      <hy-form v-bind="modalConfig" v-model="formData"></hy-form>
      <slot></slot>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="dialogVisible = false">取 消</el-button>
          <el-button type="primary" @click="handleConfirmClick">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>
```

```js
const handleConfirmClick = () => {
      dialogVisible.value = false
      if (Object.keys(props.defaultInfo).length) {
        // 编辑
        store.dispatch('system/editPageDataAction', {
          pageName: props.pageName,
          queryInfo: { ...formData.value, ...props.otherInfo },
          id: props.defaultInfo.id
        })
      } else {
        // 新建
        store.dispatch('system/newPageDataAction', {
          pageName: props.pageName,
          queryInfo: { ...formData.value, ...props.otherInfo }
        })
      }
```



### base-ui

#### hy-form

form 下使用

```js
<slot name="header"> </slot>
<el-form></el-form>
<slot name="footer"> </slot>
```

page-search 下使用

```js
<form>
<template #header> </template>
<template #footer> </template>
</form>
```

baseui/table 和 components/page-content table下使用

```js
<slot name="header">
        <div class="title">{{ title }}</div>
        <div class="handler">
          <slot name="headerHandler"></slot>
        </div>
</slot>
<el-table>
<el-table-column>
 <template #default="scope">
            <slot :name="propItem.slotName" :row="scope.row">
              {{ scope.row[propItem.prop] }}
            </slot>
</template>
</el-table-column>

</el-table>
<slot name="footer">  <slot>CopyErrorCopied
```

page-content下使用 table包裹

```js
<table>
<!-- 1.header中的插槽 -->
 <template #headerHandler>  </template>

  <template #status="scope"> {scope.row} </template>
  <template #createAt="scope">  </template>
  <template #updateAt="scope">  </template>
  <template #handler="scope"> </template>

<!-- 在page-content中动态插入剩余的插槽 -->
      <template
        v-for="item in otherPropSlots"
        :key="item.prop"
        #[item.slotName]="scope"
      >
</table>
```

在role.vue下 search组件 导入相关配置

```js
<page-search :searchFormConfig="searchFormConfig"></page-search>
```



```js
<template>
  <div class="hy-form">
    <div class="header">
      <slot name="header"></slot>
    </div>
    <el-form :label-width="labelWidth">
      <el-row>
        <template v-for="(item, index) in formItems" :key="index">
          <el-col v-bind="colLayout">
            <el-form-item
              :label="item.label"
              :rules="item.rules"
              class="form-item"
              :style="itemStyle"
              v-if="!item.isHidden"
            >
              <template v-if="item.type === 'input' || item.type === 'password'">
                <el-input
                  v-model="formData[`${item.field}`]"
                  :placeholder="item.placeHolder"
                  :show-password="item.type === 'password'"
                />
              </template>
              <template v-else-if="item.type === 'select'">
                <el-select
                  v-model="formData[`${item.field}`]"
                  :placeholder="item.placeHolder"
                  style="width: 100%"
                >
                  <el-option
                    v-for="option in item.options"
                    :key="option.value"
                    :value="option.value"
                    >{{ option.label }}</el-option
                  >
                </el-select>
              </template>
              <template v-else-if="item.type === 'datepicker'">
                <el-date-picker
                  v-model="formData[`${item.field}`]"
                  v-bind="item.otherOption"
                  style="width: 100%"
                >
                </el-date-picker>
              </template>
            </el-form-item>
          </el-col>
        </template>
      </el-row>
    </el-form>
    <div class="footer">
      <slot name="footer"></slot>
    </div>
  </div>
</template>
```



设定接口IFormItem  IForm

```js
interface ISelectOption {
  label: string
  value: any
}

type ItemType = 'input' | 'password' | 'select' | 'datepicker'

export interface IFormItem {
  field: string
  type: ItemType
  label: string
  placeHolder?: string
  rules?: any[]
  options?: ISelectOption[]
  otherOption?: any
  defaultValue?: any
  isHidden?: boolean
}

export interface IForm {
  title?: string
  formItems?: IFormItem[]
  labelWidth?: string
  itemStyle: any
  colLayout: any
}
```



```js
emit: ['update:modelValue'],
  setup(props, { emit }) {
    const formData = ref({ ...props.modelValue })

    watch(
      formData,
      (newValue) => {
        emit('update:modelValue', newValue)
      },
      { deep: true }
    )

    return {
      formData
    }
  }
```



#### hy-table

```js
<template>
  <div class="hy-table">
    <div class="header">
      <slot name="header">
        <div class="title">{{ title }}</div>
        <div class="handler">
          <slot name="headerHandler"></slot>
        </div>
      </slot>
    </div>
    <el-table :data="listData" border @selection-change="selectionChange" v-bind="childrenProps">
      <el-table-column
        v-if="showSelectColumn"
        type="selection"
        align="center"
        width="60"
      ></el-table-column>
      <el-table-column
        v-if="showIndexColumn"
        type="index"
        label="序号"
        align="center"
        width="80"
      ></el-table-column>
      <template v-for="item in propList" :key="item.prop">
        <el-table-column v-bind="item" align="center" show-overflow-tooltip>
          <template #default="scope">
            <slot :name="item.slotName" :row="scope.row">
              {{ scope.row[item.prop] }}
            </slot>
          </template>
        </el-table-column>
      </template>
      <slot></slot>
        </el-table>
    <div class="footer" v-if="showFooter">
      <slot name="footer">
        <el-pagination
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="page.currentPage"
          :page-size="page.pageSize"
          :total="totalCount"
          :page-sizes="[10, 20, 30, 40]"
          layout="total, sizes, prev, pager, next, jumper"
        >
        </el-pagination>
      </slot>
    </div>
  </div>
</template>
```

emit方法

```js
emits: ['selectionChange', 'update:page'],
  setup(props, { emit }) {
    const selectionChange = (value: any) => {
      if (props.showSelectColumn) {
        emit('selectionChange', value)
      }
    }

    const handleCurrentChange = (currentPage: number) => {
      emit('update:page', { ...props.page, currentPage })
    }
    const handleSizeChange = (pageSize: number) => {
      emit('update:page', { ...props.page, pageSize })
    }

    return {
      selectionChange,
      handleCurrentChange,
      handleSizeChange
    }
  }
```



### hooks

#### usePageModal

实际上是获取modal的引用 然后改变他的显示状态

```js
import { ref } from 'vue'
import PageModal from '@/components/page-modal'

type CallbackFn = (item?: any) => void

export const usePageModal = (newHandleCallback?: CallbackFn, editHandleCallback?: CallbackFn) => {
  const modalInfo = ref({})
  const pageModalRef = ref<InstanceType<typeof PageModal>>()
  const handleNewData = () => {
    modalInfo.value = {}
    if (pageModalRef.value) {
      pageModalRef.value.dialogVisible = true
    }
    newHandleCallback && newHandleCallback()
  }

  const handleEditData = (item: any) => {
    modalInfo.value = { ...item }
    if (pageModalRef.value) {
      pageModalRef.value.dialogVisible = true
    }
    editHandleCallback && editHandleCallback(item)
  }

  return [modalInfo, pageModalRef, handleNewData, handleEditData]
}
```



#### usePageSearch

获取引用然后执行page-content的getPageData方法去请求数据

```js
import { ref } from 'vue'
import PageContent from '@/components/page-content'

export const usePageSearch = () => {
  const pageContentRef = ref<InstanceType<typeof PageContent>>()
  const handleQueryClick = (queryInfo: any) => {
    console.log(pageContentRef.value)
    pageContentRef.value?.getPageData(queryInfo)
  }
  const handleResetClick = () => {
    pageContentRef.value?.getPageData()
  }

  return [pageContentRef, handleQueryClick, handleResetClick]
}

```



#### usePermission

获取store.state.login.permissions  



```js
import { useStore } from '@/store'

export function usePermission(pageName: string, handle: string) {
  const store = useStore()
  const permissions = store.state.login.permissions
  const handlePermission = `${pageName}:${handle}`
  return !!permissions.find((item) => item.indexOf(handlePermission) !== -1)
}

```





在page-content内

```
 // 7.按钮是否显示
    const isCreate = usePermission(props.pageName, 'create')
    const isDelete = usePermission(props.pageName, 'delete')
    const isUpdate = usePermission(props.pageName, 'update')
    const isQuery = usePermission(props.pageName, 'query')
```



## v-permission

[(20条消息) Vue---自定义指令directive的全局注册和局部注册（含vue3）_绝世唐门三哥的博客-CSDN博客_vue 全局注册directive](https://blog.csdn.net/COCOLI_BK/article/details/109074976)

## 思路分析

> - 首先因为会涉及到元素的展示和隐藏操作，所以在我们自定义指令时就不能再用beforeMount钩子函数了，而是需要用mounted函数，也就是说等元素渲染后再去控制是否展示。
> - 在mounted函数中，我们首先需要获取登录用户所拥有的权限。一般情况下在用户登录后会去请求服务器获取用户权限，然后再把权限数据保存在vuex中。这里我们要做的就是把权限数据从vuex中解析出来，便于后续使用。（为了方便展示，我们就直接使用字符串代替了）
> - 权限数据拿到以后，我们还需要判断当前元素需要哪些权限，比如删除按钮需要的就是对应的删除权限，而这个权限在元素被定义时就应该已经确定了，所以我们应该在对应的元素中把需要的权限传给我们的自定义指令，然后再通过binding.value拿到该权限
> - 最后就是对比校验，看看当前元素所需要的权限是否存在于用户的权限列表中，如果存在则说明有权限元素应该显示，否则没有权限移除对应的元素。
> - 以上便是权限自定义指令的整体实现思路，相对来说还是比较简单的，下面我们来看一下具体的代码实现。

### 权限校验代码实现

```js
<button v-permission="'add'">add</button>
<button v-permission="'del'">del</button>
<button v-permission="'update'">update</button>
<button v-permission="'query'">query</button>

const app = createApp();
app.directive('permission',{
	mounted(el,binding){
		//从服务获取用户的权限列表，一般获取后存放于vuex中，本案例为了方便演示将直接以字符串的形式展示
		//权限之间以分号分隔
		//管理员权限："add;del;update;query"
		//普通用户权限："add;del;update;query"
		let permission = "update;query",//权限字符串
			permissionList = [];//权限列表
		if(!permission) permission = "";
		permissionList = permission.split(";");

		//获取需要的权限标识，即元素给指令传进来的参数值
		let passText = binding.value,//可以是多个值，中间以分号分隔
			passTextArr = [];//将权限解析到数组中
		if(!passText) passText = "";
		passTextArr = passText.split(';');
		
		//定义一个权限标识变量，用于标识是否有权限
		let flag = false;
		//循环遍历权限列表，检测用户是否有相应的操作权限
		for(let i = 0; i < passTextArr.length; i++){
			if(permissionList.includes(passTextArr[i])){
				//如果从服务器中获取的权限列表中有组件所需的权限，则将flag置为true,同时跳出循环
				flag = true;
				break;
			}
		}
		//如果flag为false，也就是没权限则直接将元素移除或者隐藏
		if(!flag) el.parentNode && el.parentNode.removeChild(el);
	}
})

```

> 代码运行起来后，我们会发现对应管理员来说，会看到全部按钮，而对于普通用户来说则只能看到update和query按钮。

